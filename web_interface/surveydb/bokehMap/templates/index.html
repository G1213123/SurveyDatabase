<!DOCTYPE html>
{% load static %}
{% load leaflet_tags %}
<html>
<head>
      {% leaflet_js %}
      {% leaflet_css %}
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta name="viewport" content="width=1024, user-scalable=no">
      <style>
            body {
                padding: 0;
                margin: 0;
            }
            html, body, #map {
                height: 100%;
            }
        </style>
      <script type="text/javascript" src="{% static 'dist/leaflet.ajax.js' %}"></script>
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.5.0/MarkerCluster.Default.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.5.0/leaflet.markercluster.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.js"></script>


    <title>Survey Map</title>
    </head>
    <body>
    <div id="slider" style="top: 0px; right: 1px; margin: 10px 25px;"></div>
    <div style="margin-right: auto; margin-left: auto; width: 90%; margin-bottom: 10px; text-align: center;">
    <input type="number" min='1' max='35675999' id="input-number-min">
    <input type="number" min='2' max='35676000' id="input-number-max">
    <script type="text/javascript">
            var ThisYear = new Date().getFullYear()
            var slidervar = document.getElementById('slider');
            noUiSlider.create(slidervar, {
                connect: true,
                start: [ 2015, ThisYear ],
                step: 1,
                range: {
                    min: 2015,
                    max: ThisYear
                }
            });
            document.getElementById('input-number-min').setAttribute("pattern", "number");
            document.getElementById('input-number-max').setAttribute("pattern", "number");
            var inputNumberMin = document.getElementById('input-number-min');
            var inputNumberMax = document.getElementById('input-number-max');
            inputNumberMin.addEventListener('change', function(){
                slidervar.noUiSlider.set([this.value, null]);
            });
            inputNumberMax.addEventListener('change', function(){
                slidervar.noUiSlider.set([null, this.value]);
            });
            slidervar.noUiSlider.on('update', function( values, handle ) {
                //handle = 0 if min-slider is moved and handle = 1 if max slider is moved
                if (handle==0){
                    document.getElementById('input-number-min').value = Math.floor(values[0]);
                } else {
                    document.getElementById('input-number-max').value =  Math.floor(values[1]);
                }
            });
    </script>
    </div>
    <div id="map"></div>
    <script type="text/javascript">
    var head_column = ["SurveyID", "Job Number", "Project Name", "Survey", "Issue Date"]

    function out_layers(map,options){
        function protecland_marker(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 8.0,
                fillColor: '#11fe00',
                color: '#000000',
                weight: 1,
                opacity: 1.0,
                fillOpacity: 0.8,
                popupAnchor:  [-4, 0]
            })
        }
        function popUp(f,l){
            var out = [];
            if (f.properties){
                for(key in f.properties.SurveyID){
                    out.push(head_column[key]+": "+f.properties.SurveyID[key]);
                }
                l.bindPopup(out.join("<br />"));
            }
        }
        var jsonTest = new L.GeoJSON.AJAX("{% url 'data' %}",{
                coordsToLatLng: function (coords) {
                    return new L.LatLng(coords[0], coords[1], coords[2]);
                },
                onEachFeature:popUp,
                pointToLayer:protecland_marker
            }).addTo(map);

          }
    </script>
    {% leaflet_map "map" callback="window.out_layers" %}

    </body>
</html>