<!DOCTYPE html>
{% load static %}
{% load leaflet_tags %}
<html>
<head>
      {% leaflet_js %}
      {% leaflet_css %}
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta name="viewport" content="width=1024, user-scalable=no">
      <style>
            body {
                padding: 0;
                margin: 0;
            }
            html, body, #map {
                height: 100%;
            }
            .mycluster {
                background: lightblue;
                border-radius: 50%;
                width: 100px;
                height: 100px;
                border: solid;
                text-align: center;
                line-height: 24px;
                font-size: 24px;
        </style>
        <script type="text/javascript" src="{% static 'dist/leaflet.ajax.js' %}"></script>
        <script type="text/javascript" src="{% static 'dist/leaflet-search.src.js' %}"></script>
        <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.5.1/nouislider.min.js"></script>


    <title>Survey Map</title>
    </head>
    <body>

    <form action="{% url 'home' %}">

        <a class="btn btn-primary" data-toggle="collapse" href="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
            Filter Books
        </a>
        <input type="submit" class="btn btn-info" form="id_query_form" formaction="{% url 'books:csv' %}" value="Export CSV">
        <input type="submit" class="btn btn-default" form="id_query_form" formaction="{% url 'books:xls' %}" value="Export XLS">
    </form>

    <form method="get" action="." id="id_query_form">
        <p>
            {{ form.keywords }}
        </p>
        <div class="row">
            <div class="col-md-6">
                {{ form.publish_date_before }}
            </div>
            <div class="col-md-6">
                {{ form.publish_date_after }}
            </div>
        </div>

        <p></p>
        <p>
            <input class="btn btn-success" type="submit"/>
            <button type="reset" class="btn btn-info" value="Reset filters">Reset filters</button>
            <button type="reset" class="btn btn-warning" id="id_clear_filters" onclick="return resetForm(this.form);">Clear Filters</button>
        </p>

    </form>

    <div id="slider" style="top: 0px; right: 1px; margin: 10px 25px;"></div>
    <div style="margin-right: auto; margin-left: auto; width: 90%; margin-bottom: 10px; text-align: center;">
    <input type="number" min='1' max='35675999' id="input-number-min">
    <input type="number" min='2' max='35676000' id="input-number-max">
    <script type="text/javascript">
            var ThisYear = new Date().getFullYear()
            var slidervar = document.getElementById('slider');
            noUiSlider.create(slidervar, {
                connect: true,
                start: [ 2015, new Date().getFullYear() ],
                step: 1,
                range: {
                    min: 2015,
                    max: new Date().getFullYear()
                }
            });
            document.getElementById('input-number-min').setAttribute("pattern", "number");
            document.getElementById('input-number-max').setAttribute("pattern", "number");
            var inputNumberMin = document.getElementById('input-number-min');
            var inputNumberMax = document.getElementById('input-number-max');
            inputNumberMin.addEventListener('change', function(){
                slidervar.noUiSlider.set([this.value, null]);
            });
            inputNumberMax.addEventListener('change', function(){
                slidervar.noUiSlider.set([null, this.value]);
            });
            slidervar.noUiSlider.on('update', function( values, handle ) {
                //handle = 0 if min-slider is moved and handle = 1 if max slider is moved
                if (handle==0){
                    document.getElementById('input-number-min').value = Math.floor(values[0]);
                } else {
                    document.getElementById('input-number-max').value =  Math.floor(values[1]);
                }
                rangeMin = document.getElementById('input-number-min').value;
                rangeMax = document.getElementById('input-number-max').value;
            });
    </script>
    </div>
    <div id="map"></div>
    <script type="text/javascript">
    var head_column = ["SurveyID", "Job Number", "Project Name", "Survey", "Issue Date"]



    function out_layers(map, options){
    map.addLayer(new L.TileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'));

        function protecland_marker(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 8.0,
                fillColor: '#11fe00',
                color: '#000000',
                weight: 1,
                opacity: 1.0,
                fillOpacity: 0.8,
                popupAnchor:  [-4, 0]
            })
        }

        function popUp(f,l){
            var out = [];
            if (f.properties){
                for(key in f.properties.SurveyID){
                    out.push("<b>" + head_column[key]+": </b>"+f.properties.SurveyID[key]);
                }
                l.bindPopup(out.join("<br />"));
            }
        }

        var markersLayer = L.markerClusterGroup({
            iconCreateFunction: function (cluster) {
                var markers = cluster.getAllChildMarkers();
                var html = '<div class="circle">' + markers.length + '</div>';
                return L.divIcon({ html: html, className: 'mycluster', iconSize: L.point(24, 24) });
            },
            spiderfyOnMaxZoom: true, showCoverageOnHover: true, zoomToBoundsOnClick: false
        });

        var controlSearch = new L.Control.Search({
            position:'topright',
            layer: markersLayer,
            initial: true,
            zoom: 12,
            marker: false
        });

        map.addControl( controlSearch );


        var map_survey_str =  JSON.parse('{{ survey }}')
        var map_survey = JSON.parse(map_survey_str)
        L.geoJson(map_survey,{
                coordsToLatLng: function (coords) {
                    return new L.LatLng(coords[0], coords[1], coords[2]);
                },
                onEachFeature:popUp,
                pointToLayer:protecland_marker
            }).addTo(markersLayer);

        map.addLayer(markersLayer);



        }
    </script>
    {% leaflet_map "map" callback="window.out_layers" %}

    </body>
</html>